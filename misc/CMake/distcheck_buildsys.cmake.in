# Empty elements in lists are of no interest
IF(COMMAND CMAKE_POLICY)
	CMAKE_POLICY(SET CMP0007 OLD)
ENDIF(COMMAND CMAKE_POLICY)

MESSAGE("Checking source archive is in sync with build system: ...")
SET(IGNORE_LIST_CORE CMakeLists.txt Makefile.am ".svn" README pkgIndex.tcl tclIndex)
SET(CMAKE_ORIG_SRC_DIR @CMAKE_SOURCE_DIR@)
SET(CMAKE_ORIG_BINARY_DIR @CMAKE_BINARY_DIR@)

# First, handle toplevel directory
SET(DIFFLIST "")
SET(ALL_DIR_FILES "")
SET(IGNORE_LIST ${IGNORE_LIST_CORE})
FILE(READ ${CMAKE_ORIG_BINARY_DIR}/cmakefiles.cmake DIR_FILES_STRING_ORIG)
STRING(REPLACE "\\" "\;" DIR_FILES_LIST ${DIR_FILES_STRING_ORIG})
LIST(REMOVE_DUPLICATES DIR_FILES_LIST)
LIST(SORT DIR_FILES_LIST)
FILE(GLOB ALL_DIR_FILES_PATH "${CMAKE_ORIG_SRC_DIR}/*" )
FOREACH(ITEM ${ALL_DIR_FILES_PATH})
	GET_FILENAME_COMPONENT(ITEM_NAME ${ITEM} NAME)
	LIST(APPEND ALL_DIR_FILES ${ITEM_NAME})
ENDFOREACH(ITEM ${ALL_DIR_FILES_PATH})
IF(EXISTS ${CMAKE_ORIG_BINARY_DIR}/cmakepaths.cmake)
	SET(DIR_PATHS_LIST "")
	SET(NEWPATH_FILES "")
	FILE(READ ${CMAKE_ORIG_BINARY_DIR}/cmakepaths.cmake DIR_PATHS_STR_ORIG)
	STRING(REPLACE "\\" ";" DIR_PATHS_LIST ${DIR_PATHS_STR_ORIG})
	LIST(REMOVE_DUPLICATES DIR_PATHS_LIST)
	FOREACH(NEWPATH ${DIR_PATHS_LIST})
		FILE(GLOB NEWPATH_FILES "${CMAKE_ORIG_SRC_DIR}/${NEWPATH}/*" )
		FOREACH(NEWITEM ${NEWPATH_FILES})
			GET_FILENAME_COMPONENT(ITEM_NAME ${NEWITEM} NAME)
			LIST(FIND IGNORE_LIST ${ITEM_NAME} ISIGNORED)
			IF(ISIGNORED MATCHES "-1")
				LIST(APPEND ALL_DIR_FILES ${NEWPATH}/${ITEM_NAME})
			ENDIF(ISIGNORED MATCHES "-1")
		ENDFOREACH(NEWITEM ${NEWPATH_FILES})
		SET(IGNORE_LIST ${IGNORE_LIST} ${NEWPATH})
	ENDFOREACH(NEWPATH ${DIR_PATHS_LIST})
ENDIF(EXISTS ${CMAKE_ORIG_BINARY_DIR}/cmakepaths.cmake)
LIST(SORT ALL_DIR_FILES)
SET(IGNORE_LIST ${IGNORE_LIST} ${IGNORE_LIST_CORE} ${DIR_FILES_LIST})
FOREACH(ITEM ${ALL_DIR_FILES})
	LIST(FIND DIR_FILES_LIST ${ITEM} ISLISTED)
	SET(ISIGNORED 0)
	LIST(FIND IGNORE_LIST ${ITEM} ISIGNORED)
	IF(ISIGNORED MATCHES "-1")
		SET(DIFFLIST ${DIFFLIST} ${CMAKE_ORIG_SRC_DIR}/${ITEM})
	ENDIF(ISIGNORED MATCHES "-1")
ENDFOREACH(ITEM ${ALL_DIR_FILES})
IF(DIFFLIST)
	MESSAGE(FATAL_ERROR "\nFile(s) found in the source tree that are not accounted for in ${CMAKE_ORIG_SRC_DIR}/CMakeLists.txt:\n ${DIFFLIST}\n\nTo fix this, either remove the file, add the file(s) to a build target or flag it as ignored in the CMakeLists.txt file.\nThis error can also be caused by temporary files created by editors - if editing a file in the source tree try closing the editor and re-running make distcheck")
ENDIF(DIFFLIST)


# Now, handle all subdirectories

FILE(READ ${CMAKE_BINARY_DIR}/CMakeTmp/distchecklist.cmake DISTCHECK_STRING_ORIG)
STRING(REPLACE "\\" "\;" DISTCHECK_LIST_ORIG ${DISTCHECK_STRING_ORIG})
STRING(REPLACE "${CMAKE_ORIG_SRC_DIR}" "" DISTCHECK_LIST ${DISTCHECK_LIST_ORIG})
FOREACH(DIR ${DISTCHECK_LIST})
	SET(DIFFLIST "")
	SET(ALL_DIR_FILES "")
	SET(IGNORE_LIST ${IGNORE_LIST_CORE})
	IF(EXISTS ${CMAKE_ORIG_BINARY_DIR}${DIR}/cmakefiles.cmake)
		FILE(READ ${CMAKE_ORIG_BINARY_DIR}${DIR}/cmakefiles.cmake DIR_FILES_STRING_ORIG)
		STRING(REPLACE "\\" "\;" DIR_FILES_LIST ${DIR_FILES_STRING_ORIG})
		LIST(REMOVE_DUPLICATES DIR_FILES_LIST)
		LIST(SORT DIR_FILES_LIST)
		FILE(GLOB ALL_DIR_FILES_PATH "${CMAKE_ORIG_SRC_DIR}${DIR}/*" )
		FOREACH(ITEM ${ALL_DIR_FILES_PATH})
			GET_FILENAME_COMPONENT(ITEM_NAME ${ITEM} NAME)
			LIST(APPEND ALL_DIR_FILES ${ITEM_NAME})
		ENDFOREACH(ITEM ${ALL_DIR_FILES_PATH})
		IF(EXISTS ${CMAKE_ORIG_BINARY_DIR}${DIR}/cmakepaths.cmake)
			SET(DIR_PATHS_LIST "")
			SET(NEWPATH_FILES "")
			FILE(READ ${CMAKE_ORIG_BINARY_DIR}${DIR}/cmakepaths.cmake DIR_PATHS_STR_ORIG)
			STRING(REPLACE "\\" ";" DIR_PATHS_LIST ${DIR_PATHS_STR_ORIG})
			LIST(REMOVE_DUPLICATES DIR_PATHS_LIST)
			FOREACH(NEWPATH ${DIR_PATHS_LIST})
				FILE(GLOB NEWPATH_FILES "${CMAKE_ORIG_SRC_DIR}${DIR}/${NEWPATH}/*" )
				FOREACH(NEWITEM ${NEWPATH_FILES})
					GET_FILENAME_COMPONENT(ITEM_NAME ${NEWITEM} NAME)
					LIST(FIND IGNORE_LIST ${ITEM_NAME} ISIGNORED)
					IF(ISIGNORED MATCHES "-1")
						LIST(APPEND ALL_DIR_FILES ${NEWPATH}/${ITEM_NAME})
					ENDIF(ISIGNORED MATCHES "-1")
				ENDFOREACH(NEWITEM ${NEWPATH_FILES})
				SET(IGNORE_LIST ${IGNORE_LIST} ${NEWPATH})
			ENDFOREACH(NEWPATH ${DIR_PATHS_LIST})
		ENDIF(EXISTS ${CMAKE_ORIG_BINARY_DIR}${DIR}/cmakepaths.cmake)
		LIST(SORT ALL_DIR_FILES)
		SET(IGNORE_LIST ${IGNORE_LIST} ${IGNORE_LIST_CORE} ${DIR_FILES_LIST})
		FOREACH(ITEM ${ALL_DIR_FILES})
			LIST(FIND DIR_FILES_LIST ${ITEM} ISLISTED)
			SET(ISIGNORED 0)
			LIST(FIND IGNORE_LIST ${ITEM} ISIGNORED)
			IF(ISIGNORED MATCHES "-1")
				SET(DIFFLIST ${DIFFLIST} ${CMAKE_ORIG_SRC_DIR}${DIR}/${ITEM})
			ENDIF(ISIGNORED MATCHES "-1")
		ENDFOREACH(ITEM ${ALL_DIR_FILES})
		IF(DIFFLIST)
			MESSAGE(FATAL_ERROR "\nFile(s) found in the source tree that are not accounted for in ${CMAKE_ORIG_SRC_DIR}${DIR}/CMakeLists.txt:\n ${DIFFLIST}\n\nTo fix this, either remove the file, add the file(s) to a build target or flag it as ignored in the CMakeLists.txt file.\nThis error can also be caused by temporary files created by editors - if editing a file in the source tree try closing the editor and re-running make distcheck")
		ENDIF(DIFFLIST)
	ELSE()
		#MESSAGE("Note: No cmakefiles.cmake present in ${CMAKE_ORIG_SRC_DIR}${DIR}")
	ENDIF()
ENDFOREACH(DIR ${DISTCHECK_LIST})

# If we got this far, it worked
MESSAGE("Checking source archive is in sync with build system: Passed")

