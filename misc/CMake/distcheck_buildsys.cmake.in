# Empty elements in lists are of no interest
IF(COMMAND CMAKE_POLICY)
	CMAKE_POLICY(SET CMP0007 OLD)
ENDIF(COMMAND CMAKE_POLICY)

MACRO(SVN_INFO_TO_PATH_LIST SVN_RAW SVN_PATHLIST)
	SET(SVN_PROCESSING ${${SVN_RAW}})
	STRING(REGEX REPLACE "Name: [^\r\n]*" "\n" SVN_PROCESSING "${SVN_PROCESSING}")
	STRING(REGEX REPLACE "URL: [^\r\n]*" "\n" SVN_PROCESSING "${SVN_PROCESSING}")
	STRING(REGEX REPLACE "Repository [^\r\n]*" "\n" SVN_PROCESSING "${SVN_PROCESSING}")
	STRING(REGEX REPLACE "Text Last[^\r\n]*" "\n" SVN_PROCESSING "${SVN_PROCESSING}")
	STRING(REGEX REPLACE "Last [^\r\n]*" "\n" SVN_PROCESSING "${SVN_PROCESSING}")
	STRING(REGEX REPLACE "Checksum: [^\r\n]*" "\n" SVN_PROCESSING "${SVN_PROCESSING}")
	STRING(REGEX REPLACE "Revision: [^\r\n]*" "\n" SVN_PROCESSING "${SVN_PROCESSING}")
	STRING(REGEX REPLACE "Schedule: [^\r\n]*" "\n" SVN_PROCESSING "${SVN_PROCESSING}")
	STRING(REGEX REPLACE "Node Kind: [^\r\n]*" "\n" SVN_PROCESSING "${SVN_PROCESSING}")
	STRING(REGEX REPLACE "Path: " "" SVN_PROCESSING ${SVN_PROCESSING})
	STRING(REGEX REPLACE "@CMAKE_SOURCE_DIR@/" "" SVN_PROCESSING ${SVN_PROCESSING})
	STRING(REGEX REPLACE "@CMAKE_SOURCE_DIR@\r?\n" "\n" SVN_PROCESSING "${SVN_PROCESSING}")
	STRING(REGEX REPLACE "\n" ";" SVN_PROCESSING "${SVN_PROCESSING}")
	STRING(REGEX REPLACE "/;" ";" SVN_PROCESSING "${SVN_PROCESSING}")
	SET(${SVN_PATHLIST} ${SVN_PROCESSING})
ENDMACRO(SVN_INFO_TO_PATH_LIST)

SET(SVN_TREE_MODIFIED 0)

FIND_PROGRAM(SVN_EXEC svn)
IF(SVN_EXEC AND EXISTS @CMAKE_SOURCE_DIR@/.svn)
	MESSAGE(" --- Building file list from Subversion manifests: ...")
	SET(SVN_FILES "")
	EXECUTE_PROCESS(COMMAND ${SVN_EXEC} info -R @CMAKE_SOURCE_DIR@ OUTPUT_VARIABLE SVN_RAWOUT)
	SVN_INFO_TO_PATH_LIST(SVN_RAWOUT SVN_FILES)

	EXECUTE_PROCESS(COMMAND ${SVN_EXEC} status @CMAKE_SOURCE_DIR@ OUTPUT_VARIABLE SVN_RAWSTATUS)
	STRING(REGEX REPLACE "@CMAKE_SOURCE_DIR@/" "" SVN_RAWSTATUS "${SVN_RAWSTATUS}")
	STRING(REGEX REPLACE "\r?\n" ";" SVN_STATUS "${SVN_RAWSTATUS}")
	FOREACH(ITEM ${SVN_STATUS})
		IF(${ITEM} MATCHES "^M")
			SET(SVN_TREE_MODIFIED 1)
		ENDIF(${ITEM} MATCHES "^M")
		IF(${ITEM} MATCHES "^D")
			STRING(REGEX REPLACE "D[\\t\\ ]*" "" item_path "${ITEM}")
			LIST(REMOVE_ITEM SVN_FILES ${item_path})
		ENDIF(${ITEM} MATCHES "^D")
	ENDFOREACH(ITEM ${SVN_STATUS})
	LIST(SORT SVN_FILES)
	LIST(REMOVE_DUPLICATES SVN_FILES)
	STRING(REGEX REPLACE ";" "\n" SVN_FILES "${SVN_FILES}")
	FILE(WRITE @CMAKE_BINARY_DIR@/svn_files_list.txt "${SVN_FILES}")

	IF(SVN_TREE_MODIFIED)
		MESSAGE("\n**** NOTE:  Subversion reports modified source files present in the source tree.\n     Distcheck proceeding, but archives will not be suitable for release.\n")
		# TODO - mess with tarball naming so they're not releasable
	ENDIF(SVN_TREE_MODIFIED)

	MESSAGE(" --- Building file list from Subversion manifests: Done") 
ENDIF(SVN_EXEC AND EXISTS @CMAKE_SOURCE_DIR@/.svn)

MESSAGE(" --- Building 'ground truth' list of files actually present in source tree: ...") 
FILE(GLOB_RECURSE GROUND_TRUTH_RAW RELATIVE @CMAKE_SOURCE_DIR@ "@CMAKE_SOURCE_DIR@/*")
STRING(REGEX REPLACE ";[^;]*\\.svn[^;]*" "" GROUND_TRUTH_SCRUBBED "${GROUND_TRUTH_RAW}")
STRING(REGEX REPLACE "[^/]*;" ";" GROUND_TRUTH_P1 "${GROUND_TRUTH_SCRUBBED}")
STRING(REGEX REPLACE "/;" ";" GROUND_TRUTH_P1 "${GROUND_TRUTH_P1}")
LIST(REMOVE_DUPLICATES GROUND_TRUTH_P1)
STRING(REGEX REPLACE "[^/]*;" ";" GROUND_TRUTH_P2 "${GROUND_TRUTH_P1}")
STRING(REGEX REPLACE "/;" ";" GROUND_TRUTH_P2 "${GROUND_TRUTH_P2}")
LIST(REMOVE_DUPLICATES GROUND_TRUTH_P2)
SET(GROUND_TRUTH ${GROUND_TRUTH_SCRUBBED} ${GROUND_TRUTH_P1} ${GROUND_TRUTH_P2})
IF(GROUND_TRUTH)
	LIST(REMOVE_DUPLICATES GROUND_TRUTH)
	LIST(SORT GROUND_TRUTH)
	STRING(REGEX REPLACE ";" "\n" GROUND_TRUTH "${GROUND_TRUTH}")
	FILE(WRITE @CMAKE_BINARY_DIR@/ground_truth.txt "${GROUND_TRUTH}")
ENDIF(GROUND_TRUTH)
MESSAGE(" --- Building 'ground truth' list of files actually present in source tree: Done") 

MESSAGE(" --- Building list of files known to the build system: ...") 
FILE(STRINGS @CMAKE_BINARY_DIR@/cmakefiles.cmake BUILD_FILES)
FILE(STRINGS @CMAKE_BINARY_DIR@/cmakedirs.cmake IGNORED_DIRECTORIES)
FOREACH(ITEM ${IGNORED_DIRECTORIES})
	IF(SVN_EXEC AND EXISTS @CMAKE_SOURCE_DIR@/.svn)
		SET(IGNORED_FILES "")
		SET(SVN_RAWOUT "")
		EXECUTE_PROCESS(COMMAND ${SVN_EXEC} info -R ${ITEM} OUTPUT_VARIABLE SVN_RAWOUT)
		SVN_INFO_TO_PATH_LIST(SVN_RAWOUT IGNORED_FILES)
		LIST(APPEND BUILD_FILES ${IGNORED_FILES})
	ELSE(SVN_EXEC AND EXISTS @CMAKE_SOURCE_DIR@/.svn)
		FILE(GLOB_RECURSE IGNORED_FILES RELATIVE @CMAKE_SOURCE_DIR@ "${ITEM}/*")
		SET(IGNORED_PATHS ${IGNORED_FILES})
		WHILE(IGNORED_PATHS)
			SET(IGNORED_PATHS "${IGNORED_PATHS};")
			STRING(REGEX REPLACE "[^/]*;" ";" IGNORED_PATHS "${IGNORED_PATHS}")
			STRING(REGEX REPLACE "/;" ";" IGNORED_PATHS "${IGNORED_PATHS}")
			LIST(REMOVE_DUPLICATES IGNORED_PATHS)
			LIST(APPEND BUILD_FILES ${IGNORED_PATHS})
		ENDWHILE(IGNORED_PATHS)
		LIST(APPEND BUILD_FILES ${IGNORED_FILES})
	ENDIF(SVN_EXEC AND EXISTS @CMAKE_SOURCE_DIR@/.svn)
ENDFOREACH(ITEM ${DIR_FILES_LIST})
STRING(REGEX REPLACE "@CMAKE_SOURCE_DIR@/" "" BUILD_FILES "${BUILD_FILES}")
LIST(SORT BUILD_FILES)
LIST(REMOVE_DUPLICATES BUILD_FILES)
STRING(REGEX REPLACE ";" "\n" BUILD_FILES "${BUILD_FILES}")
FILE(WRITE @CMAKE_BINARY_DIR@/build_files_list.txt "${BUILD_FILES}")
MESSAGE(" --- Building list of files known to the build system: Done") 


MESSAGE(" --- Performing comparisons...") 

FILE(STRINGS @CMAKE_BINARY_DIR@/build_files_list.txt BUILD_FILES)
IF(SVN_EXEC AND EXISTS @CMAKE_SOURCE_DIR@/.svn)
	FILE(STRINGS @CMAKE_BINARY_DIR@/svn_files_list.txt SVN_FILES)
ENDIF(SVN_EXEC AND EXISTS @CMAKE_SOURCE_DIR@/.svn)
FILE(STRINGS @CMAKE_BINARY_DIR@/ground_truth.txt GROUND_TRUTH)
LIST(REMOVE_DUPLICATES BUILD_FILES)

IF(SVN_EXEC AND EXISTS @CMAKE_SOURCE_DIR@/.svn)
	SET(BUILD_FILES_NOT_IN_SVN ${BUILD_FILES})
	SET(SVN_FILES_NOT_IN_BUILD ${SVN_FILES})
	list(REMOVE_ITEM BUILD_FILES_NOT_IN_SVN ${SVN_FILES})
	list(REMOVE_ITEM SVN_FILES_NOT_IN_BUILD ${BUILD_FILES})
	list(REMOVE_ITEM GROUND_TRUTH ${SVN_FILES})
ENDIF(SVN_EXEC AND EXISTS @CMAKE_SOURCE_DIR@/.svn)
list(REMOVE_ITEM GROUND_TRUTH ${BUILD_FILES})

IF(SVN_FILES_NOT_IN_BUILD)
	STRING(REGEX REPLACE ";" "\n" SVN_FILES_NOT_IN_BUILD "${SVN_FILES_NOT_IN_BUILD}")
	MESSAGE("\nFiles listed in subversion but not accounted for in build logic: \n${SVN_FILES_NOT_IN_BUILD}\n")
ENDIF(SVN_FILES_NOT_IN_BUILD)

IF(BUILD_FILES_NOT_IN_SVN)
	STRING(REGEX REPLACE ";" "\n" BUILD_FILES_NOT_IN_SVN "${BUILD_FILES_NOT_IN_SVN}")
	MESSAGE("\nFiles present in the build logic but not accounted for in Subversion: \n${BUILD_FILES_NOT_IN_SVN}\n")
ENDIF(BUILD_FILES_NOT_IN_SVN)

IF(SVN_FILES_NOT_IN_BUILD OR BUILD_FILES_NOT_IN_SVN)
	MESSAGE(FATAL_ERROR "Distcheck cannot proceed until the above errors are corrected.")
ENDIF(SVN_FILES_NOT_IN_BUILD OR BUILD_FILES_NOT_IN_SVN)

IF(SVN_EXEC AND EXISTS @CMAKE_SOURCE_DIR@/.svn)
	IF(GROUND_TRUTH)
		SET(CPACK_EXTRA_IGNORE_FILES ${GROUND_TRUTH})
		STRING(REGEX REPLACE ";" "\n" GROUND_TRUTH "${GROUND_TRUTH}")
		MESSAGE("\nFiles unknown to both Subversion and the Build logic (will not be incorporated into dist):\n${GROUND_TRUTH}\n")
	ENDIF(GROUND_TRUTH)
ELSE(SVN_EXEC AND EXISTS @CMAKE_SOURCE_DIR@/.svn)
	IF(GROUND_TRUTH)
		MESSAGE("\nFiles unknown to the Build logic:\n${GROUND_TRUTH}\n")
		MESSAGE(FATAL_ERROR "Distcheck without subversion, unknown source files cannot be positivily identified as non-distribution files, haulting.\n")
	ELSE(GROUND_TRUTH)
		MESSAGE("\nWarning: Distcheck is being performed without subversion.  Temporary files and other unknown files present in directories explicitly ignored by the build logic will be incorporated into the archives by CPack.  If building archives for distribution, using a subversion checkout is recommended.\n")
	ENDIF(GROUND_TRUTH)
ENDIF(SVN_EXEC AND EXISTS @CMAKE_SOURCE_DIR@/.svn)

# TODO - The following lines probably need more sophisticated logic in the case of multiple
# distcheck runs to avoid repeated appendings, but should "tweak" CPack based on the distcheck results.  May
# need to remove _CPack_Packages directory, not sure
FILE(APPEND @CMAKE_BINARY_DIR@/CPackConfig.cmake "SET(CPACK_IGNORE_FILES \"\${CPACK_IGNORE_FILES};${CPACK_EXTRA_IGNORE_FILES}\")\n")
FILE(APPEND @CMAKE_BINARY_DIR@/CPackSourceConfig.cmake "SET(CPACK_IGNORE_FILES \"\${CPACK_IGNORE_FILES};${CPACK_EXTRA_IGNORE_FILES}\")\n")
FILE(APPEND @CMAKE_BINARY_DIR@/CPackConfig.cmake "SET(CPACK_SOURCE_IGNORE_FILES \"\${CPACK_SOURCE_IGNORE_FILES};${CPACK_EXTRA_IGNORE_FILES}\")\n")
FILE(APPEND @CMAKE_BINARY_DIR@/CPackSourceConfig.cmake "SET(CPACK_SOURCE_IGNORE_FILES \"\${CPACK_SOURCE_IGNORE_FILES};${CPACK_EXTRA_IGNORE_FILES}\")\n")


# If we got this far, it worked
MESSAGE("Stage 1: Passed")
